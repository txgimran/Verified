<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Verification</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea, #764ba2); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { background: white; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); max-width: 400px; width: 100%; overflow: hidden; }
        .header { background: linear-gradient(to right, #667eea, #764ba2); color: white; padding: 25px; text-align: center; }
        .header h1 { font-size: 24px; margin-bottom: 8px; }
        .content { padding: 30px; text-align: center; }
        .message { margin-bottom: 25px; color: #333; font-size: 15px; line-height: 1.5; }
        #verifyBtn { background: linear-gradient(to right, #667eea, #764ba2); color: white; border: none; padding: 16px 32px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; transition: 0.3s; }
        #verifyBtn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
        #verifyBtn:disabled { background: #ccc; cursor: not-allowed; }
        .result { margin-top: 20px; padding: 16px; border-radius: 10px; font-weight: 600; display: none; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; display: block; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; display: block; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; display: block; }
        .vpn { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; display: block; }
        .closeBtn { background: #f44336; color: white; border: none; padding: 12px 24px; border-radius: 8px; margin-top: 20px; cursor: pointer; display: none; }
        .closeBtn.show { display: inline-block; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: white; animation: spin 0.8s linear infinite; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Device Verification</h1>
            <p>One-time verification per bot</p>
        </div>
        <div class="content">
            <div class="message" id="message">Click below to verify your device. This works only once per bot.</div>
            <button id="verifyBtn">Start Verification</button>
            <div id="result"></div>
            <button class="closeBtn" id="closeBtn">Close Page</button>
        </div>
    </div>

    <script>
        (function() {
            const params = new URLSearchParams(window.location.search);
            const webhookUrl = params.get("webhookUrl");
            const botId = params.get("botId");
            const userId = params.get("userId");
            
            if (!webhookUrl || !botId) {
                document.body.innerHTML = '<div style="color:white;text-align:center;padding:40px;"><h2>Invalid Link</h2></div>';
                return;
            }
            
            const verifyBtn = document.getElementById('verifyBtn');
            const resultDiv = document.getElementById('result');
            const closeBtn = document.getElementById('closeBtn');
            const message = document.getElementById('message');
            
            // Generate device ID
            function getDeviceId() {
                let id = localStorage.getItem("device_id");
                if (!id) {
                    const comps = [navigator.userAgent, navigator.platform, screen.width + 'x' + screen.height];
                    let hash = 0;
                    for (let i = 0; i < comps.join('|').length; i++) {
                        hash = ((hash << 5) - hash) + comps.join('|').charCodeAt(i);
                        hash = hash & hash;
                    }
                    id = 'DEV' + Math.abs(hash).toString(36).toUpperCase().substring(0, 10);
                    localStorage.setItem("device_id", id);
                }
                return id;
            }
            
            const deviceId = getDeviceId();
            
            // Get verification status for THIS BOT
            function getBotVerification() {
                try {
                    const allBots = JSON.parse(localStorage.getItem("all_bots_verification") || "{}");
                    return allBots[botId] || null;
                } catch (e) {
                    return null;
                }
            }
            
            // Save verification for THIS BOT
            function saveBotVerification(status, vpn = false) {
                try {
                    const allBots = JSON.parse(localStorage.getItem("all_bots_verification") || "{}");
                    allBots[botId] = {
                        deviceId: deviceId,
                        userId: userId || null,
                        status: status,
                        vpn: vpn,
                        timestamp: Date.now(),
                        botId: botId // Store which bot this is for
                    };
                    localStorage.setItem("all_bots_verification", JSON.stringify(allBots));
                } catch (e) {}
            }
            
            // Send response to webhook
            function sendResponse(status, dataIssue = false, isVpn = false) {
                const responseData = {
                    bot_id: botId,
                    device_id: deviceId,
                    user_id: userId || null,
                    status: status,
                    data_issue: dataIssue,
                    vpn: isVpn,
                    timestamp: Date.now(),
                    user_agent: navigator.userAgent.substring(0, 100),
                    platform: navigator.platform,
                    is_one_time: true,
                    bot_specific: true
                };
                
                // Send in background
                fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(responseData)
                }).catch(() => {});
            }
            
            // Check if in Telegram
            function isTelegram() {
                return typeof window.Telegram !== 'undefined' || 
                       navigator.userAgent.toLowerCase().includes('telegram') ||
                       document.referrer.includes('t.me');
            }
            
            // Quick internet check
            async function hasInternet() {
                return new Promise(resolve => {
                    const timeout = setTimeout(() => resolve(false), 1000);
                    const img = new Image();
                    img.onload = () => { clearTimeout(timeout); resolve(true); };
                    img.onerror = () => { clearTimeout(timeout); resolve(false); };
                    img.src = 'https://www.google.com/favicon.ico?t=' + Date.now();
                });
            }
            
            // Quick VPN check
            async function hasVPN() {
                try {
                    if (typeof RTCPeerConnection !== 'undefined') {
                        const rtc = new RTCPeerConnection({iceServers: []});
                        let vpn = false;
                        const promise = new Promise(resolve => {
                            rtc.onicecandidate = (e) => {
                                if (e.candidate && e.candidate.candidate.toLowerCase().includes('.vpn.')) {
                                    vpn = true;
                                }
                            };
                            setTimeout(() => resolve(vpn), 300);
                        });
                        rtc.createDataChannel('');
                        const offer = await rtc.createOffer();
                        await rtc.setLocalDescription(offer);
                        const result = await promise;
                        rtc.close();
                        return result;
                    }
                } catch (e) {}
                return false;
            }
            
            // Main verification
            async function verify() {
                // Disable button, show loading
                verifyBtn.disabled = true;
                verifyBtn.innerHTML = '<span class="loading"></span> Verifying...';
                resultDiv.className = '';
                closeBtn.classList.remove('show');
                
                // Check existing verification for THIS BOT
                const existing = getBotVerification();
                
                if (existing) {
                    if (existing.deviceId === deviceId) {
                        if (userId && existing.userId === userId) {
                            // Same device + same user for THIS BOT
                            showResult('This device is already verified for this bot.', 'warning');
                            sendResponse('same_device', false, existing.vpn);
                            verifyBtn.innerHTML = 'Already Verified';
                            verifyBtn.style.background = '#ff9800';
                            closeBtn.classList.add('show');
                            return;
                        }
                        // Same device, different user - continue verification
                    }
                }
                
                // Check Telegram
                if (!isTelegram()) {
                    showResult('Please open in Telegram to verify.', 'error');
                    verifyBtn.disabled = false;
                    verifyBtn.innerHTML = 'Try Again';
                    return;
                }
                
                // Check internet
                if (!await hasInternet()) {
                    // Data issue - check if we have existing verification
                    if (existing) {
                        showResult('Device already verified.', 'warning');
                        sendResponse('same_device', true, existing.vpn);
                    } else {
                        // New device with data issue - treat as same device
                        showResult('Device verified.', 'success');
                        saveBotVerification('same_device');
                        sendResponse('same_device', true, false);
                    }
                    verifyBtn.innerHTML = 'Verified';
                    verifyBtn.style.background = '#4caf50';
                    closeBtn.classList.add('show');
                    return;
                }
                
                // Check VPN
                if (await hasVPN()) {
                    showResult('VPN/Proxy detected. Please disable it.', 'vpn');
                    saveBotVerification('vpn_detected', true);
                    sendResponse('vpn_detected', false, true);
                    verifyBtn.innerHTML = 'VPN Detected';
                    verifyBtn.style.background = '#f44336';
                    closeBtn.classList.add('show');
                    return;
                }
                
                // All checks passed - VERIFY
                if (existing) {
                    if (existing.deviceId === deviceId && userId && existing.userId !== userId) {
                        // Same device, different user
                        showResult('This device is already registered with a different account.', 'warning');
                        saveBotVerification('same_device');
                        sendResponse('same_device', false, false);
                        verifyBtn.innerHTML = 'Already Used';
                        verifyBtn.style.background = '#ff9800';
                    } else {
                        // Should not reach here, but safety check
                        showResult('Device already verified.', 'warning');
                        sendResponse('same_device', false, false);
                        verifyBtn.innerHTML = 'Already Verified';
                        verifyBtn.style.background = '#ff9800';
                    }
                } else {
                    // NEW VERIFICATION for this bot
                    showResult('Device verified successfully!', 'success');
                    saveBotVerification('verified');
                    sendResponse('verified', false, false);
                    verifyBtn.innerHTML = '‚úì Verified';
                    verifyBtn.style.background = '#4caf50';
                }
                
                closeBtn.classList.add('show');
            }
            
            function showResult(text, type) {
                resultDiv.className = 'result ' + type;
                resultDiv.innerHTML = text;
                resultDiv.style.display = 'block';
            }
            
            // Event listeners
            verifyBtn.addEventListener('click', verify);
            closeBtn.addEventListener('click', () => {
                try { window.close() || window.history.back(); } catch(e) {}
            });
            
            // Check on load
            const existing = getBotVerification();
            if (existing && existing.deviceId === deviceId) {
                if (userId && existing.userId === userId) {
                    message.innerHTML = 'This device is already verified for this bot.';
                    verifyBtn.disabled = true;
                    verifyBtn.innerHTML = 'Already Verified';
                    verifyBtn.style.background = '#ff9800';
                    showResult('Device already verified.', 'warning');
                    closeBtn.classList.add('show');
                }
            }
            
        })();
    </script>
</body>
</html>